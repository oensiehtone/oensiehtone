# 2. Setup and Configuration

This section outlines how the cloud lab environment was deployed, reconfigured, and stabilised to support the MitC attack simulation. It focuses on platform selection, configuration challenges, and system preparation.

## 2.1 Platform Selection and Design Decisions

OpenStack was initially considered to simulate a cloud-native infrastructure. However, due to hardware limitations and performance constraints on the host machine, this approach proved impractical.

The design was therefore pivoted to **Proxmox VE**, which provided:
- Greater stability
- Full VM control
- Nested virtualisation support
- Snapshot management
- Better suitability for iterative penetration testing

This decision improved reliability while maintaining realistic cloud behaviour.

## 2.2 Early Prototyping (VirtualBox)

VirtualBox was used during early testing to prototype:
- Windows 10 client
- Attacker VM
- Cloud server instance

However, repeated issues occurred:
- Network instability
- VM freezing under load
- “Guru Meditation” errors
- Limited nested VM support

Due to these constraints, the environment was fully migrated to Proxmox.

## 2.3 Proxmox Deployment and Nested Virtualisation Issues

After migrating to Proxmox, nested virtual machines were deployed for:
- Nextcloud server
- Zentyal IAM server
- Windows 10 client
- Kali Linux attacker

During deployment, KVM virtualisation failures occurred.

### Root Cause Identified
Windows Defender’s **Core Memory Isolation (Memory Integrity)** feature was enabled, which interfered with nested virtualisation.

Additionally:
- Mimikatz was quarantined by Windows Defender
- Hardening steps initially introduced conflicts with virtualisation

Once Memory Integrity was disabled, nested virtualisation resumed successfully.

## 2.4 VM Rebuild and Snapshot Strategy

After repeated KVM failures and VM corruption, the cloud server VM was deleted and rebuilt from scratch to ensure clean configuration.

Following successful redeployment:
- All nested VMs were rebuilt
- Hardware resource allocation was adjusted
- A stable configuration snapshot was saved

This snapshot allowed rapid recovery in the event of future instability.

## 2.5 Guru Meditation Error Resolution

During redeployment, recurring “Guru Meditation” crashes occurred.

Through iterative testing and research, the issue was traced to:
- Resource misallocation
- Memory and CPU configuration imbalance

Adjusting hardware resource assignments resolved the instability.

A snapshot of the fully converged environment was saved to prevent future rebuild cycles.

## 2.6 Final Environment State

By the end of configuration:
- IAM (Zentyal) and Nextcloud were integrated
- Windows client successfully synchronised with the cloud
- Sync tokens were generated and stored locally
- The attacker VM had network visibility
- Nested virtualisation was stable
- Recovery snapshots were in place

The lab was now fully operational and intentionally vulnerable, ready for exploitation testing.
